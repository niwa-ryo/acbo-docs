<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBGI (Pandora's Box Gittins Index) 解説</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        body {
            font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
            line-height: 1.8;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        h4 {
            color: #95a5a6;
            margin-top: 15px;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        code {
            background-color: #ecf0f1;
            color: #e74c3c;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th {
            background-color: #e74c3c;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .summary {
            background-color: #fce4ec;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            margin: 30px 0;
        }
        .equation-box {
            background-color: #f0f0f0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            overflow-x: auto;
        }
        .definition {
            background-color: #e8f5e9;
            padding: 15px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
            border-radius: 4px;
        }
        strong {
            color: #2c3e50;
        }
    </style>
</head>
<body>

<h1>PBGI (Pandora's Box Gittins Index) 解説</h1>

<h2>1. PBGIの革新</h2>

<h3>従来のコスト考慮BO手法の問題点</h3>

<h4>EIPC (Expected Improvement Per unit Cost)</h4>
<ul>
    <li><strong>長所</strong>: シンプルで計算効率的、実用的に広く使用</li>
    <li><strong>短所</strong>: 理論的に最適でない、低コスト領域を過剰サンプリング</li>
    <li><strong>問題例</strong>: 高分散・高コストの点より、低分散・低コストを選ぶ傾向</li>
</ul>

<h4>多段階先読み手法 (BMSEI等)</h4>
<ul>
    <li><strong>長所</strong>: ベイズ最適化で将来の評価を考慮した理論的に優れた性能</li>
    <li><strong>短所</strong>: 計算コストが指数的に増大、数値的に不安定、実装が複雑</li>
    <li><strong>例</strong>: BMSEI (Budgeted Multi-Step Expected Improvement) - 予算制約下で複数ステップ先を考慮</li>
</ul>

<h3>PBGIの解決策</h3>

<div class="highlight">
<strong>「Pandora's Box問題の理論を活用し、理論的基盤と計算効率を両立」</strong>
<ul>
    <li>経済学のPandora's Box問題とBOの新たな接続を発見</li>
    <li>Gittins indexによるベイズ最適方策を獲得関数として活用</li>
    <li>結果：中～高次元問題で優れた性能を実証</li>
</ul>
</div>

<h2>2. Pandora's Box問題とGittins Index</h2>

<h3>2.1 Pandora's Box問題</h3>

<div class="definition">
<strong>設定：</strong>N個の箱があり、各箱iについて：
<ul>
    <li>報酬 f(x) は確率分布 F<sub>i</sub>（既知）から生成</li>
    <li>開封コスト c(x) が必要</li>
    <li>目的：純利益（最良報酬 - 総コスト）を最大化</li>
</ul>
</div>

<h3>2.2 Gittins Indexの定義</h3>

<p>各箱のGittins Index α*(x) は以下の方程式の解：</p>

<div class="equation-box">
$$\text{EI}_f(x; g) = c(x)$$
</div>

<p>ここで：</p>
<ul>
    <li>g がGittins Index値</li>
    <li>EIは期待改善関数</li>
    <li>直感的意味：「この箱を開ける期待利益がコストと釣り合う時の既知最大値」</li>
</ul>

<h3>2.3 最適方策</h3>

<div class="mermaid">
flowchart TB
    Start([開始])
    Start --> Compute["各箱のGittins Index計算<br/>α*(x) = g where EI(x;g) = c(x)"]

    Compute --> Select["最大Gittins Indexの箱を選択<br/>x* = argmax α*(x)"]

    Select --> Compare{"α*(x*) > f_max?"}

    Compare -->|はい| Open["箱x*を開封<br/>コストc(x*)支払い"]
    Open --> Update["f_max更新"]
    Update --> Compute

    Compare -->|いいえ| Stop([停止])

    style Start fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    style Stop fill:#ffebee,stroke:#c62828,stroke-width:3px
    style Compare fill:#fff3e0,stroke:#ef6c00,stroke-width:3px
</div>

<h2>3. PBGIアルゴリズム：BOへの適用</h2>

<h3>3.1 離散から連続への拡張</h3>

<div class="mermaid">
flowchart LR
    PB["Pandora's Box<br/>・離散領域<br/>・独立報酬<br/>・既知分布"]

    PB --> PBGI["PBGI for BO<br/>・連続領域<br/>・相関あり<br/>・GP事後分布"]

    PBGI --> Variants["3つの変種<br/>1. 予算制約版<br/>2. コスト/サンプル版<br/>3. 適応減衰版"]

    style PB fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    style PBGI fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    style Variants fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
</div>

<h3>3.2 PBGI獲得関数</h3>

<h4>予算制約版</h4>

<div class="equation-box">
$$\alpha^{\text{PBGI}}_t(x) = g \quad \text{s.t.} \quad \text{EI}_{f|x_{1:t},y_{1:t}}(x; g) = \lambda c(x)$$
</div>

<ul>
    <li>λ：予算に応じて調整するハイパーパラメータ</li>
    <li>大きいλ → リスク回避的（探索を抑制）</li>
    <li>小さいλ → リスク追求的（探索を促進）</li>
</ul>

<h4>適応減衰版 (PBGI-D)</h4>

<p>停止ルール発動時にλを減衰：</p>

<div class="equation-box">
$$\lambda_{t+1} = \begin{cases}
\lambda_t/\beta & \text{if } f^*_t \geq \alpha^{\text{PBGI}}_t(x^*_t; \lambda_t) \\
\lambda_t & \text{otherwise}
\end{cases}$$
</div>

<h3>3.3 計算方法</h3>

<pre><code class="language-python"># PBGI計算の疑似コード
def compute_pbgi(x, lambda_param):
    # GP予測
    mu, sigma = gp.predict(x)
    cost = c(x)

    # 二分探索でGittins Index計算
    def ei_function(g):
        return expected_improvement(mu, sigma, g)

    # EI(x; g) = λc(x)となるgを探索
    g = bisection_search(
        func=lambda g: ei_function(g) - lambda_param * cost,
        lower=mu - 10*sigma,
        upper=mu + 10*sigma
    )
    return g
</code></pre>

<h2>4. 理論的性質</h2>

<h3>4.1 最適性の保証</h3>

<div class="definition">
<p><strong>定理1 (Weitzman, 1979)</strong>：Pandora's Box問題において、Gittins Index方策はベイズ最適</p>

<p><strong>定理2</strong>：期待予算制約問題でも、適切なλとタイブレーキング規則により、Gittins Index方策はベイズ最適</p>
</div>

<h3>4.2 λの極限挙動</h3>

<h4>λ → 0 の場合</h4>

<div class="equation-box">
$$\alpha^{\text{PBGI}}_t(x) \approx \mu_t(x) + \sigma_t(x)\sqrt{2\log\frac{\sigma_t(x)}{\lambda c(x)}}$$
</div>

<ul>
    <li>UCB獲得関数に類似</li>
    <li>信頼区間パラメータが自動調整される形</li>
</ul>

<h4>λ → ∞ の場合</h4>
<ul>
    <li>EI獲得関数に近づく</li>
    <li>コストの影響が相対的に小さくなる</li>
</ul>

<h2>5. 実験結果の要点</h2>

<h3>5.1 性能特性</h3>

<div class="mermaid">
flowchart TB
    Easy["低次元(d≤4)<br/>すべての手法が同等"]
    Medium["中次元(d=8-16)<br/>PBGIが優位または同等"]
    Hard["高次元(d≥32)<br/>ランダム探索と同等"]

    Easy --> Medium
    Medium --> Hard

    style Easy fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style Medium fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    style Hard fill:#ffebee,stroke:#c62828,stroke-width:2px
</div>

<h3>5.2 主要な実験結果</h3>

<table>
    <tr>
        <th>問題タイプ</th>
        <th>PBGI性能</th>
        <th>特記事項</th>
    </tr>
    <tr>
        <td>ベイズ後悔 (d=8-16)</td>
        <td>最良または同等</td>
        <td>特に中難易度で優位</td>
    </tr>
    <tr>
        <td>合成関数 (Ackley, Levy)</td>
        <td>優秀</td>
        <td>多峰性問題で効果的</td>
    </tr>
    <tr>
        <td>実応用 (Pest Control)</td>
        <td>最良</td>
        <td>高次元(d=25)でも性能維持</td>
    </tr>
    <tr>
        <td>Lunar Lander</td>
        <td>優秀</td>
        <td>未知コストでも対応可能</td>
    </tr>
    <tr>
        <td>Rosenbrock</td>
        <td>PBGI-Dが優秀</td>
        <td>単峰性ではEI系が強い</td>
    </tr>
</table>

<h3>5.3 コスト設定による挙動の違い</h3>

<h4>一様コスト（通常のBO）</h4>
<ul>
    <li>PBGIは通常のBOでも競争力のある性能</li>
    <li>設計がコスト考慮型でも汎用性を持つ</li>
</ul>

<h4>変動コスト</h4>
<ul>
    <li>PBGIの真価を発揮</li>
    <li>EIPCと異なる質的な判断が可能</li>
</ul>

<h2>6. 実装上の重要点</h2>

<h3>6.1 勾配計算</h3>

<div class="equation-box">
$$\nabla\alpha^{\text{PBGI}}(x) = \nabla\mu(x) + \frac{\phi\left(\frac{\mu(x)-\alpha^{\text{PBGI}}(x)}{\sigma(x)}\right)\nabla\sigma(x) - \lambda\nabla c(x)}{\Phi\left(\frac{\mu(x)-\alpha^{\text{PBGI}}(x)}{\sigma(x)}\right)}$$
</div>

<ul>
    <li>明示的な解析的勾配が利用可能</li>
    <li>L-BFGS等の勾配法で効率的に最適化</li>
</ul>

<h3>6.2 計算効率</h3>

<ul>
    <li><strong>二分探索</strong>：100回反復で十分な精度</li>
    <li><strong>計算時間</strong>：EIより若干遅いが、MSEI/BMSEIより大幅に高速</li>
    <li><strong>並列化</strong>：複数の候補点で独立に計算可能</li>
</ul>

<h3>6.3 ハイパーパラメータ選択</h3>

<table>
    <tr>
        <th>パラメータ</th>
        <th>推奨値</th>
        <th>影響</th>
    </tr>
    <tr>
        <td>λ (PBGI)</td>
        <td>10<sup>-4</sup></td>
        <td>探索-活用のトレードオフ</td>
    </tr>
    <tr>
        <td>λ<sub>0</sub> (PBGI-D)</td>
        <td>10<sup>-1</sup></td>
        <td>初期の探索度合い</td>
    </tr>
    <tr>
        <td>β (PBGI-D)</td>
        <td>2</td>
        <td>減衰速度</td>
    </tr>
</table>

<h2>7. PBGIの利点と限界</h2>

<h3>利点</h3>

<ol>
    <li><strong>理論的基盤</strong>: Pandora's Box理論による最適性保証</li>
    <li><strong>計算効率</strong>: 単純な二分探索で実装可能</li>
    <li><strong>汎用性</strong>: コスト有無に関わらず良好な性能</li>
    <li><strong>拡張性</strong>: 未知コスト、確率的コストにも対応</li>
</ol>

<h3>限界</h3>

<ol>
    <li><strong>相関の仮定</strong>: 理論は独立性を前提（実際は事後分布で緩和）</li>
    <li><strong>離散化</strong>: 連続領域での理論保証は近似的</li>
    <li><strong>パラメータ感度</strong>: PBGIはλに敏感（PBGI-Dで緩和）</li>
</ol>

<h2>8. 今後の展望</h2>

<h3>拡張の可能性</h3>

<ul>
    <li><strong>バッチ設定</strong>: 並列評価への拡張</li>
    <li><strong>他のGittins Index</strong>: Discounted Gittins Index等の活用</li>
    <li><strong>理論強化</strong>: 連続領域での収束性証明</li>
</ul>

<h3>応用分野</h3>

<ul>
    <li>ハイパーパラメータ最適化（クラウドGPU利用時）</li>
    <li>ロボット制御（エネルギーコスト考慮）</li>
    <li>材料設計（実験コストが変動）</li>
</ul>

<div class="summary">
<h2>まとめ</h2>
<p>PBGIは、<strong>経済学のPandora's Box理論とBOを融合</strong>することで、コスト考慮型最適化に<strong>理論的基盤と実用性を両立</strong>した新しい獲得関数。特に<strong>中～高次元の多峰性問題</strong>で既存手法を上回る性能を示し、<strong>計算効率</strong>も実用的。Gittins Index理論の豊富な知見をBOに活用する第一歩として重要な貢献。</p>
</div>

</body>
</html>